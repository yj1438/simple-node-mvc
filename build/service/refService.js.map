{"version":3,"sources":["service/refService.js"],"names":[],"mappings":"AAAA;;AAEA,IAAM,WAAW,QAAQ,oBAAR,CAAjB;AACA,IAAM,cAAc;AAChB,SAAK,OADW;AAEhB,SAAK,OAFW;AAGhB,SAAK,OAHW;AAIhB,WAAO,SAJS;AAKhB,SAAK;AALW,CAApB;AAOA;;;;;AAKA,QAAQ,MAAR,GAAiB,UAAS,IAAT,EAAe,QAAf,EAAyB;AACtC;AACA,QAAI,KAAK,KAAK,EAAd;AAAA,QACI,MAAM,KAAK,GADf;AAAA,QAEI,WAAW,YAAY,KAAK,QAAjB,CAFf;AAGA,QAAI,CAAC,EAAD,IAAO,CAAC,GAAR,IAAe,CAAC,QAApB,EAA8B;AAC1B,oBAAY,SAAS,MAAT,EAAiB,IAAjB,CAAZ;AACA;AACH;AACD,QAAI,MAAM,mCAAmC,QAAnC,GAA8C,aAA9C,GAA8D,EAA9D,GAAmE,MAAnE,GAA4E,GAA5E,GAAkF,OAAlF,GACH,2BADG,GAC2B,QAD3B,GACsC,KADtC,GAC8C,QAD9C,GACyD,OADnE;AAEA,QAAI,YAAY,YAAY,YAAY,CAAE,CAA1C;AACA,aAAS,MAAT,CAAgB,GAAhB,EAAqB,EAArB,EAAyB,SAAzB;AACH,CAbD;;AAgBA;;;AAGA,QAAQ,SAAR,GAAoB,UAAS,GAAT,EAAc,QAAd,EAAwB;AACxC,aAAS,MAAT,CAAgB,0CAAhB,EAA4D,GAA5D,EAAiE,QAAjE;AACH,CAFD","file":"service/refService.js","sourcesContent":["'use strict';\n\nconst Database = require('../common/database');\nconst ProtocolMap = {\n    '1': 'http1',\n    '2': 'spdy2',\n    '3': 'spdy3',\n    '3.1': 'spdy3_1',\n    '4': 'http2'\n}; \n/**\n * 记录点击率\n * data: id-id ref-来源 (protocal)-参照ProtocolMap的 key\n * 通过ON DUPLICATE KEY UPDATE语法，实现一句 SQL 有则加1，无则添加的功用\n */\nexports.addCTR = function(data, callback) {\n    //INSERT INTO stat_ref(id, ref, http1) values ('babytree', 'babytree', 1) ON DUPLICATE KEY UPDATE http1 = http1 + 1;\n    let id = data.id,\n        ref = data.ref,\n        protocol = ProtocolMap[data.protocol];\n    if (!id || !ref || !protocol) {\n        callback && callback('参数错误', null);\n        return;\n    }\n    let sql = \"INSERT INTO stat_ref(id, ref, \" + protocol + \") values ('\" + id + \"', '\" + ref + \"', 1)\"\n         + \" ON DUPLICATE KEY UPDATE \" + protocol + \" = \" + protocol + \" + 1;\";\n    let _callback = callback || function () {};\n    Database.handle(sql, {}, _callback);\n}\n\n\n/**\n * 根据 ref 获取此条记录\n */\nexports.findByRef = function(ref, callback) {\n    Database.handle('SELECT * FROM stat_ref a WHERE a.ref = ?', ref, callback);\n}\n"],"sourceRoot":"/source/"}