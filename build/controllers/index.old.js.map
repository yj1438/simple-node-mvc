{"version":3,"sources":["controllers/index.old.js"],"names":[],"mappings":"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","file":"controllers/index.old.js","sourcesContent":["'use strict';\nconst request = require('request'),\n    fs = require('fs'),\n    crypto = require('crypto');\n\nconst protocolMap = {\n    '1': 'http 1.x',\n    '2': 'spdy/2',\n    '3': 'spdy/3',\n    '3.1': 'spdy/3.1',\n    '4': 'http 2'\n};\n\nfunction makeUaData (uaData, userAgent) {\n    let data = {};\n    let uaMatch;\n    data.uaString = userAgent;\n    data.os_name = uaData[\"os_name\"];\n    data.os_version = uaData[\"os_versionNumber\"];\n    data.agent_name = uaData[\"agent_name\"];\n    data.agent_version = uaData[\"agent_version\"];\n    /*\n     * 处理特殊容器\n     */\n    //UC\n    uaMatch = userAgent.match(/(UCBrowser)\\/([\\d.]+)/)                          //UC\n            || userAgent.match(/(MicroMessenger)\\/([\\d.]+)/)                    //微信\n            || userAgent.match(/(MQQBrowser)\\/([\\d.]+)/)                        //QQ\n            || userAgent.match(/(baidubrowser)\\/([\\d.]+)/)                      //baidu\n            || userAgent.match(/(LieBaoFast)\\/([\\d.]+)/)                        //猎豹\n            || userAgent.match(/(SogouMobileBrowser)\\/([\\d.]+)/)                //搜狗\n            || userAgent.match(/(360 Aphone Browser) \\(([\\d.]+)\\)/);            //360\n    if (uaMatch) {\n        data.agent_name = uaMatch[1];\n        data.agent_version = uaMatch[2];\n    } else if (data.agent_name === 'Android Webkit Browser') {\n        //泛 chrome 浏览器\n        if (uaMatch = userAgent.match(/Chrome\\/([\\d.]+)/)) {\n            data.agent_name = 'Chrome';\n            data.agent_version = uaMatch[1];\n        }\n        //android browser\n        if (uaMatch = userAgent.match(/Version\\/([\\d.]+)/)) {\n            data.agent_name = 'Android Browser';\n            data.agent_version = data.agent_version + ', ' + uaMatch[1]; \n        }\n        //webview\n        if (uaMatch = userAgent.match(/wv/)) {\n            data.agent_name = 'Android Webview';\n        }\n    }\n    return data;\n}\n\n/**\n * \n */\nexports.index = function () {\n    \n    //this.renderJson(this.params);\n    let self_req = this.req,\n        data = {},\n        userAgent = this.req.headers['user-agent'],\n        //API KEY ea731ec4\n        //UA_PARSE_URL = 'http://useragentapi.com/api/v3/json/ea731ec4/' + encodeURIComponent(userAgent);\n        UA_PARSE_URL = 'http://www.useragentstring.com/?uas=' + encodeURIComponent(userAgent) + '&getJSON=all';\n    \n    //取 HASH\n    let hashId;\n    try {\n        let hash = crypto.createHash('sha256');\n        hash.update(userAgent);\n        hashId = hash.digest('hex');\n    } catch (err) {\n        //throw err;\n        console.log(new Date() + \": \" + userAgent);\n        hashId = null;\n    }\n    \n    if (!hashId) {\n        this.renderJson({info: userAgent});\n        return;\n    }\n\n    //ua hash 进行过滤\n    fs.readFile('data/hash.json', 'utf8', (err, data) => {\n        if (err) {\n            throw err;\n            return;\n        }\n        if (!data || data.indexOf(hashId) === -1) {\n            console.log('add new userAgent : ' + hashId);\n            request(UA_PARSE_URL, function (error, response, body) {\n                if (!error && response.statusCode === 200) {\n                    let uaData = makeUaData(JSON.parse(body), userAgent);\n                    uaData.hashId = hashId;\n                    uaData.isSpdy = self_req.isSpdy ? 'yes' : 'no';\n                    uaData.protocol = protocolMap[self_req.spdyVersion];\n                    //写信息\n                    fs.appendFile('data/ua_data.json', JSON.stringify(uaData) + '\\n', 'utf8', (err) => {\n                        if (err)\n                            throw err;\n                    });\n                    //写 hashId\n                    fs.appendFile('data/hash.json', hashId + \"\\n\", 'utf8', (err) => {\n                        if (err) {\n                            throw err;\n                        }\n                    });\n                }\n            });\n            /*\n            fs.appendFile('data/userAgent.json', hashId + '\\n' + userAgent + '\\n', 'utf8', (err) => {\n                if (err)\n                    throw err;\n            });\n            */\n        }\n    });\n    \n    data.title = \"Welcome to HTTP/2 statistics\";\n    data.userAgent = userAgent;\n    data.isSpdy = '当前客户端' + (this.req.isSpdy ? '支持' : '不支持') + ' SPDY/H2 !!!';\n    data.protocol = protocolMap[this.req.spdyVersion];\n    this.render('index/index', data);\n};\n"],"sourceRoot":"/source/"}