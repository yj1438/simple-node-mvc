{"version":3,"sources":["common/wechat/getTicket.js"],"names":[],"mappings":"AAAA;;AAEA,IAAM,UAAU,QAAQ,SAAR,CAAhB;;AAEA,IAAM,WAAW,QAAQ,YAAR,CAAjB;;AAEA,IAAI,YAAY,QAAQ,aAAR,CAAhB;;AAEA,IAAI,aAAa,4EAAjB;;AAEA,SAAS,SAAT,CAAmB,QAAnB,EAA6B;AACzB,QAAM,QAAQ,KAAK,KAAL,CAAW,IAAI,IAAJ,GAAW,OAAX,KAAuB,IAAlC,CAAd;AACA,QAAI,QAAQ,UAAU,cAAtB,EAAsC;AAClC,iBAAS,UAAU,KAAV,EAAiB;AACtB,gBAAI,CAAC,KAAL,EAAY;AACP,uBAAO,QAAP,KAAoB,UAArB,IAAoC,SAAS,IAAT,CAApC;AACH,aAFD,MAEO;AACH,6BAAa,aAAa,KAA1B;AACA,wBAAQ,UAAR,EAAoB,UAAU,KAAV,EAAiB,QAAjB,EAA2B,IAA3B,EAAiC;AACjD,wBAAI,CAAC,KAAD,IAAU,SAAS,UAAT,KAAwB,GAAtC,EAA2C;AACvC,4BAAM,OAAO,KAAK,KAAL,CAAW,IAAX,CAAb;AACC,+BAAO,QAAP,KAAoB,UAArB,IAAoC,SAAS,KAAK,MAAd,CAApC;AACA,gCAAQ,GAAR,CAAY,IAAI,IAAJ,KAAa,aAAzB;AACA,gCAAQ,GAAR,CAAY,IAAZ;AACA,kCAAU,SAAV,CAAoB,IAApB;AACH,qBAND,MAMO;AACF,+BAAO,QAAP,KAAoB,UAArB,IAAoC,SAAS,IAAT,CAApC;AACH;AACJ,iBAVD;AAWH;AACJ,SAjBD;AAkBH,KAnBD,MAmBO;AACF,eAAO,QAAP,KAAoB,UAArB,IAAoC,SAAS,UAAU,MAAnB,CAApC;AACH;AACJ;;AAED,OAAO,OAAP,GAAiB,SAAjB","file":"common/wechat/getTicket.js","sourcesContent":["'use strict';\n\nconst request = require('request');\n\nconst getToken = require('./getToken');\n\nlet DataCache = require('./DataCache');\n\nlet TICKET_URL = 'http://api.weixin.qq.com/cgi-bin/ticket/getticket?type=jsapi&access_token=';\n\nfunction getTicket(callback) {\n    const nowTs = Math.floor(new Date().getTime() / 1000);\n    if (nowTs > DataCache.ticket_expries) {\n        getToken(function (token) {\n            if (!token) {\n                (typeof callback === 'function') && callback(null);\n            } else {\n                TICKET_URL = TICKET_URL + token;\n                request(TICKET_URL, function (error, response, body) {\n                    if (!error && response.statusCode === 200) {\n                        const data = JSON.parse(body);\n                        (typeof callback === 'function') && callback(data.ticket);\n                        console.log(new Date() + '：获取新的ticket');\n                        console.log(data);\n                        DataCache.setTicket(data);\n                    } else {\n                        (typeof callback === 'function') && callback(null);\n                    }\n                });\n            }\n        })\n    } else {\n        (typeof callback === 'function') && callback(DataCache.ticket);\n    }\n}\n\nmodule.exports = getTicket;"],"sourceRoot":"/source/"}